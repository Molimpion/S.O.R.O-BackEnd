# ===================================================================
# apresentação Geraldo
# API S.O.R.O. BOMBEIROS - Cenário: Incêndio Residencial (CORRIGIDO)
# ===================================================================

# --- VARIÁVEIS GLOBAIS ---
@hostname = https://api-bombeiros-s-o-r-o.onrender.com
# @hostname = http://localhost:3000

@adminToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2ZThjYmYzYy1jYmUxLTQ5ZjgtODllNi1hOWI1YjhlMjkzNzQiLCJwcm9maWxlIjoiQURNSU4iLCJpYXQiOjE3NjM3NTEwMjQsImV4cCI6MTc2Mzc3OTgyNH0.598E81K3kWQg4f5BrcwnVkUxbIHAM91SoBM-_3ZC18g
@analistaToken = ### CORREÇÃO: Adicionada variável para o token do analista
@grupamentoId =
@unidadeId =
@viaturaId =
@analistaId =
@ocorrenciaId =


# ===================================================================
# FASE 1: SETUP INICIAL E AUTENTICAÇÃO
# ===================================================================

### 1.1 - Cadastrar o usuário ADMIN (Com Senha Definida)
# @name createVictoriaAdminComSenha
POST {{hostname}}/api/v3/auth/register
Content-Type: application/json

{
    "name": "Comandante Manoel",
    "email": "olimpiommelo@gmail.com",
    "profile": "ADMIN",
    "matricula": "100001-y" 
}

### 1.2 - Fazer login como ADMIN
# @name loginAdmin
POST {{hostname}}/api/v3/auth/login
Content-Type: application/json

{
    "email": "cmt.murilo@bombeiros.pe.gov.br",
    "password": "senhaAdminForte123"
}

### CORREÇÃO: Captura dinâmica do token de Admin
@adminToken = {{loginAdmin.response.body.token}}

### Deletar o usuário Comandante Victoria
# @name deleteVictoria
DELETE {{hostname}}/api/v3/users/dacfef0a-589a-4c2f-9007-2cc6bac182af
Authorization: Bearer {{adminToken}}

### 1.3 - Testar Acesso Admin (Listar Usuários)
GET {{hostname}}/api/v3/users
Authorization: Bearer {{adminToken}}

# ===================================================================
# FASE 2: CRIAÇÃO DE DADOS MÍNIMOS DE DEPENDÊNCIA (ADMIN)
# ===================================================================

### 2.1 - POST: Criar Grupamento (Ex: Metropolitano / Comando)
# @name createGrupamento
POST {{hostname}}/api/v3/grupamentos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "nome_grupamento": "Grupamento de Bombeiros Metropolitano", "sigla": "GBM" }

### GET: Listar todos os grupamentos (Para encontrar o ID)
GET {{hostname}}/api/v3/grupamentos
Authorization: Bearer {{adminToken}}

### POST: Criar a Unidade QCG (Corretamente)
# @name createUnidade
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Quartel Central do Recife (QCG)",
    "endereco_base": "Av. João de Barros, 399 - Soledade, Recife - PE",
    "id_grupamento_fk": "{{createGrupamento.response.body.data.id_grupamento}}"
}

### 1.4 - TESTE: Cadastrar Novo Usuário (Admin) - Deve Enviar E-mail
### CORREÇÃO: Movido para depois da criação da Unidade, para que a variável exista
# @name registerTestUserWithEmail
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} 
Content-Type: application/json

{
    "name": "Usuario Teste Email",
    "email": "SEU_EMAIL_DE_TESTE_REAL@exemplo.com", // <-- SUBSTITUA AQUI
    "profile": "ANALISTA",
    "matricula": "999999-9", // <-- Use uma matrícula nova
    "id_unidade_operacional_fk": "{{createUnidade.response.body.data.id_unidade}}" // Reutiliza a unidade criada antes
}


# --- ADIÇÕES COM BASE NA NOSSA CONVERSA ---

### 2.2.1 - POST: Criar Unidade (Centro de Manutenção)
# @name createUnidadeCMan
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Centro de Manutenção (CMan)",
    "endereco_base": "Av. Rio Capibaribe, 147 - São José, Recife - PE",
    ### CORREÇÃO: Usando ID dinâmico ao invés de fixo
    "id_grupamento_fk": "{{createGrupamento.response.body.data.id_grupamento}}"
}

### 2.2.2 - POST: Criar Unidade (Centro de Atividades Técnicas)
# @name createUnidadeCAT
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Centro de Atividades Técnicas (CAT)",
    "endereco_base": "Av. João de Barros, 399 - Soledade, Recife - PE",
    ### CORREÇÃO: Usando ID dinâmico ao invés de fixo
    "id_grupamento_fk": "{{createGrupamento.response.body.data.id_grupamento}}"
}

### 2.2.3 - POST: Criar Grupamento (Incêndio)
# @name createGrupamentoGBI
POST {{hostname}}/api/v3/grupamentos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "nome_grupamento": "Grupamento de Bombeiros de Incêndio", "sigla": "GBI" }

### 2.2.3.1 - POST: Criar Unidade-Sede do GBI
# @name createUnidadeGBI
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Sede do GBI - Prazeres",
    "endereco_base": "Estrada da Batalha, S/N - Prazeres, Jaboatão dos Guararapes - PE",
    "id_grupamento_fk": "{{createGrupamentoGBI.response.body.data.id_grupamento}}"
}

### 2.2.4 - POST: Criar Grupamento (Atendimento Pré-Hospitalar)
# @name createGrupamentoGBAPH
POST {{hostname}}/api/v3/grupamentos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "nome_grupamento": "Grupamento de Atendimento Pré-Hospitalar", "sigla": "GBAPH" }

### 2.2.4.1 - POST: Criar Unidade-Sede do GBAPH
# @name createUnidadeGBAPH
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Sede do GBAPH (Resgate) - Varadouro",
    "endereco_base": "Av. Presidente Kennedy, S/N - Varadouro, Olinda - PE",
    "id_grupamento_fk": "{{createGrupamentoGBAPH.response.body.data.id_grupamento}}"
}


### 2.2.5 - POST: Criar Grupamento (Salvamento)
# @name createGrupamentoGBS
POST {{hostname}}/api/v3/grupamentos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "nome_grupamento": "Grupamento de Bombeiros de Salvamento", "sigla": "GBS" }

### 2.2.5.1 - POST: Criar Unidade-Sede do GBS
# @name createUnidadeGBS
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Sede do GBS - Abreu e Lima",
    "endereco_base": "Av. Dr. Reinaldo Pinho Alves, S/N - Distrito Industrial, Abreu e Lima - PE",
    "id_grupamento_fk": "{{createGrupamentoGBS.response.body.data.id_grupamento}}"
}


### 2.2.6 - POST: Criar Grupamento (Marítimo)
# @name createGrupamentoGBMar
POST {{hostname}}/api/v3/grupamentos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "nome_grupamento": "Grupamento de Bombeiros Marítimos", "sigla": "GBMar" }

### 2.2.6.1 - POST: Criar Unidade-Sede do GBMar
# @name createUnidadeGBMar
POST {{hostname}}/api/v3/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_unidade": "Sede do GBMar - Piedade",
    "endereco_base": "Avenida Beira Mar, 606A - Piedade, Jaboatão dos Guararapes - PE",
    "id_grupamento_fk": "{{createGrupamentoGBMar.response.body.data.id_grupamento}}"
}


### 2.3 - POST: Criar Natureza (Ex: Incêndio)
# @name createNatureza
POST {{hostname}}/api/v3/naturezas
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "descricao": "INCENDIO" }

### 2.4 - POST: Criar Grupo (Ex: Incêndio em Edificação)
# @name createGrupo
POST {{hostname}}/api/v3/grupos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "descricao_grupo": "Incêndio em Edificação",
    "id_natureza_fk": "{{createNatureza.response.body.data.id_natureza}}"
}

### 2.5 - POST: Criar Subgrupo (Ex: Incêndio em Residência)
# @name createSubgrupo
POST {{hostname}}/api/v3/subgrupos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "descricao_subgrupo": "Incêndio em Residência Unifamiliar",
    "id_grupo_fk": "{{createGrupo.response.body.data.id_grupo}}"
}


### 2.7 - POST: Criar Forma Acervo (Ex: Telefone 193)
# @name createFormaAcervo
POST {{hostname}}/api/v3/formas-acervo
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "descricao": "TELEFONE 193" }

### CORREÇÃO: Adicionando as requisições faltantes de Município e Bairro

### 2.8 - POST: Criar Município (Recife)
# @name createMunicipio
POST {{hostname}}/api/v3/municipios
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_municipio": "Recife"
}

### 2.9 - POST: Criar Bairro (Boa Vista)
# @name createBairro
POST {{hostname}}/api/v3/bairros
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
    "nome_bairro": "Boa Vista",
    "id_municipio_fk": "{{createMunicipio.response.body.id_municipio}}"
}


# ===================================================================
# FASE 3: CRIAÇÃO EM LOTE DE ANALISTAS POR UNIDADE
# ===================================================================

### 3.1.1 - Cadastrar Analista (Quartel Central do Recife - QCG)
# @name createAnalistaQCG
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Operador Silva (QCG)",
    "email": "op.silva.qcg@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200003-C",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidade.response.body.data.id_unidade}}"
}

### 3.1.2 - Cadastrar Analista (Centro de Atividades Técnicas - CAT)
# @name createAnalistaCAT
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Analista Barbosa (CAT)",
    "email": "ana.barbosa.cat@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200004-D",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidadeCAT.response.body.data.id_unidade}}"
}

### 3.1.3 - Cadastrar Analista (Centro de Manutenção - CMan)
# @name createAnalistaCMan
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Operador Rocha (CMan)",
    "email": "op.rocha.cman@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200005-E",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidadeCMan.response.body.data.id_unidade}}"
}

### 3.1.4 - Cadastrar Analista (Sede do GBI - Incêndio)
# @name createAnalistaGBI
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Operador Souza (GBI)",
    "email": "op.souza.gbi@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200006-F",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidadeGBI.response.body.data.id_unidade}}"
}

### 3.1.5 - Cadastrar Analista (Sede do GBAPH - Resgate)
# @name createAnalistaGBAPH
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Operadora Lima (GBAPH)",
    "email": "op.lima.gbaph@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200007-G",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidadeGBAPH.response.body.data.id_unidade}}"
}

### 3.1.6 - Cadastrar Analista (Sede do GBS - Salvamento)
# @name createAnalistaGBS
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Operador Pereira (GBS)",
    "email": "op.pereira.gbs@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200008-H",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidadeGBS.response.body.data.id_unidade}}"
}

### 3.1.7 - Cadastrar Analista (Sede do GBMar - Marítimo)
# @name createAnalistaGBMar
POST {{hostname}}/api/v3/auth/register
Authorization: Bearer {{adminToken}} ### CORREÇÃO: Adicionado Auth (rota é protegida)
Content-Type: application/json

{
    "name": "Operadora Alves (GBMar)",
    "email": "op.alves.gbmar@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456",
    "profile": "ANALISTA",
    "matricula": "200009-I",
    ### CORREÇÃO: Usando ID dinâmico da Unidade
    "id_unidade_operacional_fk": "{{createUnidadeGBMar.response.body.data.id_unidade}}"
}

### 3.2 - Login como ANALISTA
# @name loginAnalista
POST {{hostname}}/api/v3/auth/login
Content-Type: application/json

{
    "email": "op.alves.gbmar@bombeiros.pe.gov.br",
    "password": "senhaAnalistaSegura456"
}

### CORREÇÃO: Captura dinâmica do token de Analista
@analistaToken = {{loginAnalista.response.body.token}}


### 3.3 - POST: Criar Ocorrência (Incêndio Residencial na Boa Vista)
# @name createOcorrencia
POST {{hostname}}/api/v3/ocorrencias
Authorization: Bearer {{analistaToken}}
Content-Type: application/json

{
    "data_acionamento": "2025-10-21T10:15:00Z",
    "hora_acionamento": "2025-10-21T10:15:00Z",
    "nr_aviso": "AV-DIA1-001",
    "id_subgrupo_fk": "{{createSubgrupo.response.body.data.id_subgrupo}}",
    ### CORREÇÃO: Usando a variável da requisição createBairro
    "id_bairro_fk": "{{createBairro.response.body.id_bairro}}",
    "id_forma_acervo_fk": "{{createFormaAcervo.response.body.data.id_forma_acervo}}"
}

### 3.4 - GET: Listar Ocorrências (Pendentes de Hoje)
GET {{hostname}}/api/v3/ocorrencias?status=PENDENTE&dataInicio=2025-10-21T00:00:00Z
Authorization: Bearer {{analistaToken}}

### 3.5 - GET: Detalhes da Ocorrência Criada
# @name getOcorrenciaById
GET {{hostname}}/api/v3/ocorrencias/{{createOcorrencia.response.body.id_ocorrencia}}
Authorization: Bearer {{analistaToken}}


# ===================================================================
# FASE 4: TESTES ANALÍTICOS E DE RELATÓRIOS (ADMIN)
# ===================================================================

### 4.1 - GET: KPI Ocorrências por Status
GET {{hostname}}/api/v3/dashboard/ocorrencias-por-status
Authorization: Bearer {{adminToken}}

### 4.2 - GET: KPI Ocorrências por Bairro (Do Bairro Boa Vista)
### CORREÇÃO: Usando a variável da requisição createBairro
GET {{hostname}}/api/v3/dashboard/ocorrencias-por-bairro?bairroId={{createBairro.response.body.id_bairro}}
Authorization: Bearer {{adminToken}}

### 4.3 - GET: Relatório CSV (Ocorrências de Incêndio Pendentes)
GET {{hostname}}/api/v3/relatorios?type=csv&status=PENDENTE&subgrupoId={{createSubgrupo.response.body.data.id_subgrupo}}
Authorization: Bearer {{adminToken}}

### 4.4 - GET: Relatório PDF (Todas as ocorrências do dia)
GET {{hostname}}/api/v3/relatorios?type=pdf&dataInicio=2025-10-21T00:00:00Z
Authorization: Bearer {{adminToken}}

### GET: Listar todas as naturezas (Para pegar os IDs)
GET {{hostname}}/api/v3/naturezas
Authorization: Bearer {{adminToken}}

### GET: Listar todos os Grupos (Para pegar os IDs)
GET {{hostname}}/api/v3/grupos
Authorization: Bearer {{adminToken}}

### GET: Listar todos os Subgrupos (Para pegar os IDs)
GET {{hostname}}/api/v3/subgrupos
Authorization: Bearer {{adminToken}}