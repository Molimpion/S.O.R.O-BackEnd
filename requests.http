# ===================================================================
# SUÍTE DE TESTES COMPLETA E ORDENADA - API PROJETO BOMBEIROS
# ===================================================================

# --- VARIÁVEIS GLOBAIS ---
@hostname = http://localhost:3000
@adminToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJkZGUzMGM3Zi03MGQ2LTQzYjQtOGMxMi0zYTJjMjE2YjNkODkiLCJwcm9maWxlIjoiQURNSU4iLCJpYXQiOjE3NjA1NDU5NTgsImV4cCI6MTc2MDU3NDc1OH0.nezHiZKXWilT0QS33RQXk1b7z545l3gzJu6x8TgIrHc
@analistaToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIwNTE5N2YzYi04OWM1LTQxODAtOTJlMi0xNGNlZDRiODUwZDYiLCJwcm9maWxlIjoiQU5BTElTVEEiLCJpYXQiOjE3NjA1NDYzNTIsImV4cCI6MTc2MDU3NTE1Mn0.1AQ4SKBPQnHE7tbX1htQnJC1WkULgWVnTu7knuDu5rg
@userId =
@ocorrenciaId =


# ===================================================================
# FASE 1: CRIAÇÃO DO PRIMEIRO ADMIN E LOGIN
# ===================================================================

### 1.1 - Cadastrar o primeiro usuário ADMIN (sem unidade operacional)
# @name createAdmin
POST {{hostname}}/api/auth/register
Content-Type: application/json

{
  "name": "Super Admin",
  "email": "admin@bombeiros.com",
  "password": "senhaSuperSecreta123",
  "profile": "ADMIN",
  "matricula": "000000-0"
}

### 1.2 - Fazer login como ADMIN
# AÇÃO: Execute e copie o token da resposta para a variável @adminToken acima.
# @name loginAdmin
POST {{hostname}}/api/auth/login
Content-Type: application/json

{
  "email": "admin@bombeiros.com",
  "password": "senhaSuperSecreta123"
}


# ===================================================================
# FASE 2: SETUP ADMINISTRATIVO (com token de Admin)
# ===================================================================

### 2.1 - Cadastrar Grupamento
# @name createGrupamento
POST {{hostname}}/api/grupamentos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "nome_grupamento": "Grupamento Tático",
  "sigla": "GT"
}

### 2.2 - Cadastrar Unidade Operacional
# @name createUnidade
POST {{hostname}}/api/unidades-operacionais
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "nome_unidade": "Quartel Central",
  "id_grupamento_fk": "{{createGrupamento.response.body.id_grupamento}}"
}

### 2.3 - Cadastrar Bairro
# @name createBairro
POST {{hostname}}/api/bairros
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "nome_bairro": "BOA_VISTA" }

### 2.4 - Cadastrar Hierarquia de Classificação
# @name createNatureza
POST {{hostname}}/api/naturezas
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "descricao": "PIROTECNICO" }

###
# @name createGrupo
POST {{hostname}}/api/grupos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "descricao_grupo": "Queima de Fogos",
  "id_natureza_fk": "{{createNatureza.response.body.id_natureza}}"
}

###
# @name createSubgrupo
POST {{hostname}}/api/subgrupos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "descricao_subgrupo": "Queima de Fogos em Local Proibido",
  "id_grupo_fk": "{{createGrupo.response.body.id_grupo}}"
}

### 2.5 - Cadastrar Forma de Acervo
# @name createFormaAcervo
POST {{hostname}}/api/formas-acervo
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{ "descricao": "Telefone 193" }

### 2.6 - Cadastrar Viatura
# @name createViatura
POST {{hostname}}/api/viaturas
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "tipo_vt": "Comando e Controle",
  "numero_viatura": "CAT_01",
  "id_unidade_operacional_fk": "{{createUnidade.response.body.id_unidade}}"
}


# ===================================================================
# FASE 3: CRIAÇÃO DE USUÁRIOS OPERACIONAIS E OCORRÊNCIAS
# ===================================================================

### 3.1 - Cadastrar um usuário ANALISTA (agora com Unidade)
# @name createAnalista
POST {{hostname}}/api/auth/register
Content-Type: application/json

{
  "name": "Soldado Carlos",
  "email": "carlos.soldado@bombeiros.com",
  "password": "senhaValida123",
  "profile": "ANALISTA",
  "matricula": "123456-7",
  "id_unidade_operacional_fk": "{{createUnidade.response.body.id_unidade}}"
}

### 3.2 - Login como ANALISTA
# AÇÃO: Execute e copie o token para a variável @analistaToken acima.
# @name loginAnalista
POST {{hostname}}/api/auth/login
Content-Type: application/json

{
  "email": "carlos.soldado@bombeiros.com",
  "password": "senhaValida123"
}

### 3.3 - Criar uma Ocorrência (com token de Analista)
# @name createOcorrencia
POST {{hostname}}/api/ocorrencias
Authorization: Bearer {{analistaToken}}
Content-Type: application/json

{
  "data_acionamento": "2025-10-15T14:00:00Z",
  "hora_acionamento": "2025-10-15T14:00:00Z",
  "nr_aviso": "AV-2025-10-15-001",
  "id_subgrupo_fk": "{{createSubgrupo.response.body.id_subgrupo}}",
  "id_bairro_fk": "{{createBairro.response.body.id_bairro}}",
  "id_forma_acervo_fk": "{{createFormaAcervo.response.body.id_forma_acervo}}"
}


# ===================================================================
# FASE 4: CONSULTAS E ANÁLISES
# ===================================================================

### 4.1 - Listar Ocorrências (com filtro)
GET {{hostname}}/api/ocorrencias?status=PENDENTE
Authorization: Bearer {{analistaToken}}

### 4.2 - Ver Detalhes de uma Ocorrência
GET {{hostname}}/api/ocorrencias/{{createOcorrencia.response.body.id_ocorrencia}}
Authorization: Bearer {{analistaToken}}

### 4.3 - Gerar Relatório CSV (com token de Admin)
GET {{hostname}}/api/relatorios/ocorrencias/csv
Authorization: Bearer {{adminToken}}

### 4.4 - Obter KPI de Ocorrências por Status
GET {{hostname}}/api/dashboard/ocorrencias-por-status
Authorization: Bearer {{analistaToken}}


# ===================================================================
# FASE 5: TESTES DE SEGURANÇA
# ===================================================================

### 5.1 - Tentar aceder a rota de admin com token de ANALISTA
# Resultado esperado: Erro 403 Forbidden
GET {{hostname}}/api/users
Authorization: Bearer {{analistaToken}}